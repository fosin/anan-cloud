statefulset:
  updateStrategy:
    type: RollingUpdate
  #å¹¶è¡Œåˆ›å»ºpod,é»˜è®¤ä¸ºæŒ‰é¡ºåºæ‰§è¡ŒOrderedReady
  podManagementPolicy: OrderedReady
  replicaCount: 1
secret:
  type: Opaque
  confs:
    mysql.root.password: "local"
    mysql.replication.user: "repl"
    mysql.platform.dbname: "anan_platform"
    mysql.platform.user: "anan"
    mysql.platform.password: "local"
    mysql.exam.dbname: "exam"
    mysql.exam.user: "anan"
    mysql.exam.password: "local"
    mysql.nacos.dbname: "nacos"
    mysql.nacos.user: "nacos"
    mysql.nacos.password: "local" #nacosçš„æ•°æ®åº“å¯†ç ä¸­ä¸èƒ½åŒ…å«é€—å·(,)ï¼Œè¸©äº†å‡ æ¬¡å‘äº†ðŸ˜¶
    mysql.grafana.dbname: "grafana"
    mysql.grafana.user: "grafana"
    mysql.grafana.password: "local"
initContainers:
  - name: init-mysql
    image: mysql:5.7
    imagePullPolicy: Always
    command:
      - bash
      - "-c"
      - |
        set -ex

        # ä»Žconfig-mapä¸­å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°emptyDirï¼Œå› ä¸ºconfig-mapç›®å½•ä¸ºåªè¯»
        cp /etc/mysql/mgr.cnf /etc/mysql/conf.d/mgr.cnf

        # ä»ŽPodåºå·ç”Ÿæˆserver-id, =~ åˆ¤æ–­å­—ç¬¦ä¸²åŒ…å«å…³ç³»ï¼ŒBASH_REMATCHå˜é‡å­˜å‚¨åŒ¹é…ç»“æžœ
        [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
        export POD_NUMBER=${BASH_REMATCH[1]}

        echo -e "server_id=$((1 + $POD_NUMBER))" >> /etc/mysql/conf.d/mgr.cnf
        # #å‘Šè¯‰æ’ä»¶ä½¿ç”¨IPåœ°å€ï¼Œç«¯å£33068ç”¨äºŽæŽ¥æ”¶ç»„ä¸­å…¶ä»–æˆå‘˜è½¬å…¥è¿žæŽ¥
        echo -e "loose-group_replication_local_address=\"`hostname`.`echo $MY_POD_SERVICE_HEADLESS`.`echo $MY_POD_NAMESPACE`.svc.cluster.local:33068\"" >> /etc/mysql/conf.d/mgr.cnf
        echo -e "report_host=\"`hostname`.`echo $MY_POD_SERVICE_HEADLESS`.`echo $MY_POD_NAMESPACE`.svc.cluster.local\"" >> /etc/mysql/conf.d/mgr.cnf

        #é…ç½®æ˜¯å¦è‡ªåŠ¨å¼•å¯¼ç»„
        if [[ $POD_NUMBER == 0 ]]; then
          echo -e "loose-group_replication_bootstrap_group=ON" >> /etc/mysql/conf.d/mgr.cnf
        else
          echo -e "loose-group_replication_bootstrap_group=OFF" >> /etc/mysql/conf.d/mgr.cnf
        fi
    env:
      - name: MY_POD_SERVICE_HEADLESS
        valueFrom:
          configMapKeyRef:
            name: mysql-mgr
            key: mysql.mgr.service.headless
      - name: MY_POD_NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
    volumeMounts:
      - name: mysql-mgr
        mountPath: /etc/mysql/
      - name: temp
        mountPath: /etc/mysql/conf.d/
containers:
  - image: mysql:5.7
    imagePullPolicy: IfNotPresent
    resources:
      limits:
        memory: 512Mi
      requests:
        cpu: 1m
        memory: 256Mi
    env:
      - name: TZ
        value: Asia/Shanghai
      - name: MYSQL_ROOT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: mysql-mgr
            key: mysql.root.password
    readinessProbe:
      periodSeconds: 45
      failureThreshold: 3
      exec:
        command:
          - /bin/sh
          - "-c"
          - MYSQL_PWD="${MYSQL_ROOT_PASSWORD}"
          - mysql -u root -e "SELECT 1"
    livenessProbe:
      periodSeconds: 60
      failureThreshold: 2
      exec:
        command:
          - /bin/sh
          - "-c"
          - MYSQL_PWD="${MYSQL_ROOT_PASSWORD}"
          - mysql -u root -e "SELECT 1"
    volumeMounts:
      - name: data
        mountPath: /var/lib/mysql
      - name: log
        mountPath: /var/log/mysql
      - name: temp
        mountPath: /etc/mysql/conf.d/
volumes:
  - name: temp
    emptyDir: {}
  - name: mysql-mgr
    configMap:
      name: mysql-mgr
      items:
        - key: mgr.cnf
          path: mgr.cnf
persistence:
  - name: data
    storageClassName: local-storage
    size: 2G
    accessMode: ReadWriteOnce
    mountPath: /var/lib/mysql
    local:
      - hostname: examtest0
        path: /data/mysql-mgr0
  - name: log
    storageClassName: local-storage
    size: 2G
    accessMode: ReadWriteOnce
    mountPath: /var/log/mysql
    local:
      - hostname: examtest0
        path: /data/logs/mysql-mgr0
service:
  type: NodePort
  ports:
    - port: 3306
      name: server
